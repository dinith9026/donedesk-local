
## Infrastructure

### IAM

DoneDesk provides AWS access through **Users** and **Roles**.

**Users** are the entities that perform the requests against AWS services. Users have no permissions attached except the minimum required to access the system and assume roles. Permission to access services is granted by **Role**, _not_ by User.  The following users can access the system

- com.codeship.app
- com.grok-interactive.josh-freeman
- com.grok-interactive.lauren-fackler
- com.grok-interactive.tarek-hafez
- com.herokudns.com.donedesk.app-production
- com.herokudns.com.donedesk.app-staging

**Roles** are the class of functionality that users can assume.  Like Users, **Roles** have only the required permissions attached to function correctly.  Permission to access a service is given to roles in that services access policy.

DoneDesk provides access to the following roles:

- com.donedesk.aws.development
- com.donedesk.aws.production
- com.donedesk.aws.staging
- com.donedesk.aws.test
- com.donedesk.deployer
- ecsInstanceRole (Auto-generated by ECS)
- ecsServiceRole (Auto-generated by ECS)
- rds-monitoring-role (Auto-generated by RDS)

The roles **com.donedesk.aws.development** and **com.donedesk.aws.production** are unique and used as _Task Roles_ for running tasks. ECS assigns the task the appropriate role, and that task now has access to AWS services like any other user assuming role.

We allow users to assume a role based upon a role's _Trust Relationship_. A role's _Trust Relationship_ must enumerate the users, roles, and services that may assume it's role. Users must _also_ be given the *sts:AssumeRole* permission to assume a role. Roles will change less frequently than users. By configuring AWS service policies to use roles instead of users, the policies remain more consistent when users change.


### ![S3](https://console.aws.amazon.com/s3/home?region=us-west-2)

DoneDesk uses S3 for object storage. An S3 bucket provides access to IAM Roles via Bucket Policy. These policies can be found under `./aws/` in their corresponding directory, and are updated through CD.

There are two major infrastructure components stored in each S3 bucket: the `.secrets` object, which stores each application environment's secret configurations; and the `tls/` directory, which contains the certificates and supporting files required for LetsEncrypt. The application will fail to launch without both these components present.

DoneDesk uses the following S3 buckets:

- com.donedesk.app.development
- com.donedesk.app.production
- com.donedesk.app.staging
- com.donedesk.app.test


### ![KMS](https://console.aws.amazon.com/iam/home?region=us-west-2#/encryptionKeys/us-west-2)

DoneDesk uses KMS for the super-secret-ultra-master keys that encrypt data. Typically, these keys should be used only as master keys to encrypt/decrypt more frequently used keys. KMS keys are used on first launch of the application to decrypt the `.secrets` file stored in each S3 bucket.

Review testing key trust relationsihp

### VPC


### ![CloudWatch Logging](https://us-west-2.console.aws.amazon.com/cloudwatch/home?region=us-west-2)

AWS provides a logging driver for ECS that captures data sent to `/dev/stdout`. When setting up an application (rails, nginx, etc.), log to **STDOUT**.

Each container instance–app, nginx_proxy, and letsencrypt–have log streams in their corresponding Log Group. When a new instance of the application launches, ECS generates a new log stream for each instance.

### EC2

DoneDesk employees three (3) EC2 instances. Two in active use, and one in reserve. During deployments, ECS will launch the new tasks in the reserve EC2 instance. If the new task passes the ECS and ELB tests, then ELB switches DNS to the new task and puts the old EC2 instance into reserve.

This is a **Blue-Green Deployment**.

Because production and staging use the same EC2 isntance pool, they have identical environments. Their primary difference is their assigned _IAM Role_ and the application configuration and secrets for that role.

Configuration of EC2 is handled via Launch Configuration

### ![EC2 Launch Configurations](https://us-west-2.console.aws.amazon.com/ec2/autoscaling/home?region=us-west-2#LaunchConfigurations:) and ![AutoScaling Groups](https://us-west-2.console.aws.amazon.com/ec2/autoscaling/home?region=us-west-2#AutoScalingGroups:)

Auto Scaling Groups describe the conditions and expectations for the EC2 instance pool. Auto Scaling Groups control which VPC instances are launched into, the number of instances, the conditions for a satisfactory launch, conditions for launching new instances, and so on.

EC2 Launch Configurations describe the type and configuration of the EC2 instances to be launched by an Auto Scaling Group. Where Auto Scaling Groups describe the instance pool, Launch Configurations describe the individual instances in that pool.

Our Launch Configurations have a few notes of interest:

- The Amazon Machine Image (AMI) must be an image compatible with ECS. For the `us-west-2` region, that AMI ID is **ami-596d65208**.
- User Data is a script that runs on boot. When using ECS, each instance *_must_* add the ECS Cluster like so:

```bash
#!/bin/bash
echo ECS_CLUSTER=donedesk >> /etc/ecs/ecs.config
```

-


AMI

Security Groups


### RDS

### Glacier


### ECS

Cluster, Task Definitions, and Tasks Oh My!

### Autoscaling Groups and Launch Configurations

###
